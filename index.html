<head>
   <title>torrentweb - an anonymous and decentralized network</title>
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
   <style>
      h1, p, div { text-align: center; }
      html       { background: #fffffe; }
   </style>
</head>
</head>
<body>
   <script src="./torrentweb.debug.js"></script>
   <div class="container">
      <h2>Welcome to the TorrentWeb network</h2>
         <p align='right'>I know a guy, who knows a guy...</p>

      <div class="well">
         <br>
         <div class="myAddress"></div>
         <div id="response">
         </div>
         <br>
         <h2>Nodes</h2>
         <div class="nodesTable"></div>
         <br>
         <h2>Log</h2>
         <div class="log"></div>
      </div>
   </div>
   <script>
      var torrentWeb = new TorrentWeb({ debugMode: true })
     
      torrentWeb.on('created', (nodeAddress) => {
        document.querySelector('.myAddress').innerHTML = '<h3>My address: <h2>' + nodeAddress + '</h2></h3>'
        log('Created - Node Address: ' + nodeAddress)
      })
      
      torrentWeb.on('nodeUpdate', (nodes) => showNodes(nodes))
      torrentWeb.on('message', (remoteNodeAddress, message) => log('message from - <B>' + remoteNodeAddress+'</B>: <br>' + JSON.stringify(message,null,2)))
      
      function sendMessage(nodeAddress, message) {
         var dt = new Date();
         const msg = {title: "Ping message", from: torrentWeb.nodeAddress, dt}
         torrentWeb.sendMessage(nodeAddress, msg)
      } 

      function showNodes (nodesMap) {
       const nodes = Array.from(nodesMap)
       console.log(`showNodes -> nodes`, nodes)
      
        var tableRows = ''

        nodes.map(node => {
          const addr = node[0]
          const details = node[1]
          tableRows += `
          <tr>
          <th scope="row">${addr}</th>
          <td>${details.peerConn.channelName}</td>
          <td>${details.t}</td>
          <td><a href="javascript:void(0);" onclick="sendMessage('${addr}');"> send ping </a></td>
          </tr>`
       })
      
        const table = `<table class="table table-dark">
        <thead>
        <tr>
        <th scope="col">Address</th>
        <th scope="col">Channel</th>
        <th scope="col">Time</th>
        <th scope="col">Ping</th>
        </tr>
        </thead>
        <tbody>` + tableRows +
        `</tbody>
        </table>`
      
        document.querySelector('.nodesTable').innerHTML = table 
      }
      
      function log (str) {
        var p = document.createElement('p')
        p.innerHTML = str
        document.querySelector('.log').appendChild(p)
      }
          
   </script>
</body>
</html>